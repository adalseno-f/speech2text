name: Build and Release Multi-Platform App

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v0.1.0, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub UI

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS Application (with FFmpeg)
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Download and bundle FFmpeg
        run: |
          chmod +x download_ffmpeg.sh
          ./download_ffmpeg.sh

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install deepgram-sdk pyside6 python-dotenv pyinstaller

      - name: Build macOS app with PyInstaller (with bundled FFmpeg)
        run: |
          pyinstaller AudioTranscription.spec

      - name: Create DMG installer
        run: |
          # Install create-dmg
          brew install create-dmg

          # Create DMG
          create-dmg \
            --volname "Audio Transcription" \
            --volicon "dist/AudioTranscription.app/Contents/Resources/icon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "AudioTranscription.app" 200 190 \
            --hide-extension "AudioTranscription.app" \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "AudioTranscription-macOS-FFmpeg.dmg" \
            "dist/AudioTranscription.app" || true

          # Fallback: If create-dmg fails, create a simple DMG
          if [ ! -f "AudioTranscription-macOS-FFmpeg.dmg" ]; then
            echo "Creating simple DMG..."
            hdiutil create -volname "Audio Transcription" -srcfolder "dist/AudioTranscription.app" -ov -format UDZO "AudioTranscription-macOS-FFmpeg.dmg"
          fi

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create ZIP archive (alternative download)
        run: |
          cd dist
          zip -r ../AudioTranscription-macOS-FFmpeg.zip AudioTranscription.app
          cd ..

      - name: Upload DMG as artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioTranscription-macOS-FFmpeg-DMG
          path: AudioTranscription-macOS-FFmpeg.dmg
          retention-days: 30

      - name: Upload ZIP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioTranscription-macOS-FFmpeg-ZIP
          path: AudioTranscription-macOS-FFmpeg.zip
          retention-days: 30

  build-windows:
    name: Build Windows Application (with FFmpeg)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Download FFmpeg for Windows
        shell: bash
        run: |
          mkdir -p bin
          curl -L "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -o ffmpeg.zip
          unzip -j ffmpeg.zip "ffmpeg-*-essentials_build/bin/ffmpeg.exe" -d bin/
          rm ffmpeg.zip
          chmod +x bin/ffmpeg.exe

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install deepgram-sdk pyside6 python-dotenv pyinstaller

      - name: Build Windows app with PyInstaller
        run: |
          pyinstaller AudioTranscription.spec

      - name: Create ZIP archive
        shell: bash
        run: |
          cd dist
          7z a -tzip ../AudioTranscription-Windows-FFmpeg.zip AudioTranscription
          cd ..

      - name: Upload ZIP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioTranscription-Windows-FFmpeg-ZIP
          path: AudioTranscription-Windows-FFmpeg.zip
          retention-days: 30

  build-linux:
    name: Build Linux Application (AppImage with FFmpeg)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2 file

      - name: Download FFmpeg for Linux
        run: |
          chmod +x download_ffmpeg.sh
          ./download_ffmpeg.sh

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install deepgram-sdk pyside6 python-dotenv pyinstaller

      - name: Build Linux app with PyInstaller
        run: |
          pyinstaller AudioTranscription.spec

      - name: Download AppImage tools
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          sudo mv appimagetool-x86_64.AppImage /usr/local/bin/appimagetool

      - name: Create AppImage
        run: |
          # Create AppDir structure
          APP_DIR="dist/AudioTranscription.AppDir"
          mkdir -p "$APP_DIR/usr/bin"
          mkdir -p "$APP_DIR/usr/lib"
          mkdir -p "$APP_DIR/usr/share/applications"
          mkdir -p "$APP_DIR/usr/share/icons/hicolor/256x256/apps"

          # Copy application files
          cp -r dist/AudioTranscription/* "$APP_DIR/usr/bin/"

          # Create desktop file
          cat > "$APP_DIR/usr/share/applications/audiotranscription.desktop" << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Audio Transcription
          Comment=Audio transcription and enhancement tool
          Exec=AudioTranscription
          Icon=audiotranscription
          Categories=AudioVideo;Audio;
          Terminal=false
          EOF

          # Create AppRun script
          cat > "$APP_DIR/AppRun" << 'EOFRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/AudioTranscription" "$@"
          EOFRUN
          chmod +x "$APP_DIR/AppRun"

          # Create symbolic links
          ln -sf usr/share/applications/audiotranscription.desktop "$APP_DIR/audiotranscription.desktop"

          # Build AppImage
          ARCH=x86_64 appimagetool "$APP_DIR" "AudioTranscription-Linux-FFmpeg-x86_64.AppImage"
          chmod +x AudioTranscription-Linux-FFmpeg-x86_64.AppImage

      - name: Create tarball (alternative)
        run: |
          cd dist
          tar -czf ../AudioTranscription-Linux-FFmpeg-x86_64.tar.gz AudioTranscription
          cd ..

      - name: Upload AppImage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioTranscription-Linux-FFmpeg-AppImage
          path: AudioTranscription-Linux-FFmpeg-x86_64.AppImage
          retention-days: 30

      - name: Upload tarball as artifact
        uses: actions/upload-artifact@v4
        with:
          name: AudioTranscription-Linux-FFmpeg-tarball
          path: AudioTranscription-Linux-FFmpeg-x86_64.tar.gz
          retention-days: 30

  create-release:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            AudioTranscription-macOS-FFmpeg-DMG/AudioTranscription-macOS-FFmpeg.dmg
            AudioTranscription-macOS-FFmpeg-ZIP/AudioTranscription-macOS-FFmpeg.zip
            AudioTranscription-Windows-FFmpeg-ZIP/AudioTranscription-Windows-FFmpeg.zip
            AudioTranscription-Linux-FFmpeg-AppImage/AudioTranscription-Linux-FFmpeg-x86_64.AppImage
            AudioTranscription-Linux-FFmpeg-tarball/AudioTranscription-Linux-FFmpeg-x86_64.tar.gz
          body: |
                # Audio Transcription App ${{ steps.get_version.outputs.version }}

                ## Download

                **For macOS users:**
                - Download `AudioTranscription-macOS-FFmpeg.dmg` (Recommended) - **Includes FFmpeg**
                - Or download `AudioTranscription-macOS-FFmpeg.zip` (Alternative) - **Includes FFmpeg**

                **For Windows users:**
                - Download `AudioTranscription-Windows-FFmpeg.zip` - **Includes FFmpeg**

                **For Linux users:**
                - Download `AudioTranscription-Linux-FFmpeg-x86_64.AppImage` (Recommended) - **Includes FFmpeg**
                - Or download `AudioTranscription-Linux-FFmpeg-x86_64.tar.gz` (Alternative) - **Includes FFmpeg**

                ## Installation

                ### macOS - DMG Method (Recommended):
                1. Download and open `AudioTranscription-macOS-FFmpeg.dmg`
                2. Drag **AudioTranscription.app** to your **Applications** folder
                3. Eject the DMG
                4. Launch from Applications

                ### macOS - ZIP Method:
                1. Download and extract `AudioTranscription-macOS-FFmpeg.zip`
                2. Move **AudioTranscription.app** to your **Applications** folder
                3. Launch from Applications

                ### Windows:
                1. Download and extract `AudioTranscription-Windows-FFmpeg.zip`
                2. Run **AudioTranscription.exe**

                ### Linux - AppImage Method (Recommended):
                1. Download `AudioTranscription-Linux-FFmpeg-x86_64.AppImage`
                2. Make it executable: `chmod +x AudioTranscription-Linux-FFmpeg-x86_64.AppImage`
                3. Run: `./AudioTranscription-Linux-FFmpeg-x86_64.AppImage`

                ### Linux - Tarball Method:
                1. Download and extract `AudioTranscription-Linux-FFmpeg-x86_64.tar.gz`
                2. Navigate to extracted folder
                3. Run: `./AudioTranscription`

                ## First Launch

                **macOS:** On first launch, macOS may show a security warning:
                1. **Right-click** the app and select **Open**
                2. Click **Open** in the confirmation dialog

                Or go to **System Preferences > Security & Privacy** and click **Open Anyway**

                **Windows:** Windows Defender may show a warning. Click "More info" and then "Run anyway".

                **Linux:** If the AppImage doesn't run, install FUSE: `sudo apt install fuse libfuse2`

                ## Requirements

                - **macOS**: 10.15 (Catalina) or later
                - **Windows**: Windows 10 or later
                - **Linux**: Most modern distributions (Ubuntu 20.04+, Fedora 34+, etc.)
                - **FFmpeg**: Now bundled with the app! No separate installation needed.
                - **Deepgram API key**: Required for transcription (configure in Settings tab)

                ## Features

                - ğŸµ Audio file playback (MP3, WAV, M4A, OGG, FLAC, MP4)
                - ğŸ™ï¸ Audio enhancement/cleaning for school lessons (FFmpeg included!)
                - ğŸ”‡ Click and keyboard noise removal
                - ğŸšï¸ Multiple speaker voice profiles (male, female, mixed)
                - ğŸ“ Speech-to-text transcription using Deepgram AI
                - ğŸ‡®ğŸ‡¹ Italian language support
                - ğŸ’¾ Export transcriptions as TXT and JSON
                - ğŸ”§ Cross-platform: macOS, Windows, and Linux support

                ## What's New in v0.1.1

                - âœ… Added "mixed" speaker voice option for recordings with both male and female voices
                - âœ… Added click removal filter (removes clicking sounds)
                - âœ… Added FFT denoiser for keyboard typing noise removal
                - âœ… Linux AppImage support for easy Linux deployment

                ## Previous Changes (v0.1.0 â†’ v0.2.0)

                - âœ… Fixed API key storage issues on macOS (now uses proper Application Support directory)
                - âœ… FFmpeg now bundled with the app - no separate installation needed!
                - âœ… Improved FFmpeg detection (checks common installation paths)
                - âœ… Increased timeout for long audio files (up to 10 minutes)
                - âœ… Added Windows support
                - âœ… Better error handling and user feedback

                ## Support

                For issues or questions, please [open an issue](https://github.com/${{ github.repository }}/issues).
              draft: false
              prerelease: false
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
